---
title: "Differential abundance"
author: "Marcela Aragon"
date: "2024-08-02"
output: html_document
---

Continue with differential abundance analysis, one per experiment as you've been doing. Follow the same code that you already have, don't get creative!!

Use the ps_ITS object in Results/pre-procesing ITS and that one split it by experiment, it's not a big deal at this point that the filtering was not done by experiment as probably the same samples are going to be missing. Later with time, come back to the ps_ITS, for now it is forbidden!! 

#Load libraries

```{r}

#Load libraries

#microbiome data
library(phyloseq)
library(microbiome)
library(metagMisc)
library(metagenomeSeq)#CSS normalization
library(vegan)
library(ape)

#data handling
library(dplyr)
library(tidyr)
library(tibble)
library(readxl)
library(purrr) #melts df of lists into a single one
library(varhandle)

#stats
library(stats) #stats
library(rempsyc) #tables
library(scales)#rounds p value
library(EcolUtils) #pairwise Adonis

#ploting
library(ggpubr)
library(ggplot2)
library(RColorBrewer) #nice colors for plots
library(UpSetR)
library(ComplexHeatmap)
library(scran)
library(cowplot)
library(VennDiagram)
library(pscl)
library(MASS)
library(phytools)
library(VennDiagram)
library(itol.toolkit)

#Differential Abundance
library(ANCOMBC) #ANCOM

```

## Settings for plots
```{r}

#Set plots theme
ggplot2::theme_set(theme_bw())

#Set colors
color_stress <- c("#BFBFBF", "#E69F00", "#4472C4")
color_experiment <- c("#CC3399", "#70AD47")

color_ctrl_vs_JA <- c("#BFBFBF", "#E69F00")
color_ctrl_vs_SA <- c("#BFBFBF",  "#4472C4")
color_JA <- "#E69F00"
color_SA <- "#4472C4"
color_experiment <- c("#CC3399", "#70AD47")
fonts <- windowsFonts()

```

#16S

```{r}
#Load data

#16S
load(file = "./amplicon_data/Phyloseq_objects/ps_16S_split.RData")
ps_16S_split

```


##Pre-filtering

```{r}
#First, make a pre-filtering of those taxa that are low in prevalence (<20%)

ps_16S_filt <- lapply(ps_16S_split, function(ps){
  metagMisc::phyloseq_filter_prevalence(ps, prev.trh = 0.20, #at least 20% of samples
                                          abund.trh = NULL) #no filtering by abundance
})

#check
ps_16S_filt #less than 2,000 taxa

```

##ANCOM
```{r}

set.seed(123)


ancom <- lapply(ps_16S_split, function(ps){
  set.seed(123)
  ANCOMBC::ancombc(phyloseq = ps, 
                      formula = "plant_pathway_induced", 
                      p_adj_method = "fdr", #same as "BH" Benjamini & Hochberg
                      prv_cut = 0.20,
                      group = "plant_pathway_induced", 
                      struc_zero = TRUE, #with structural zero's
                      neg_lb = FALSE, #classifies structural zero's if it's zero and not its asymptotic lower bound 
                      tol = 1e-5,               
                      max_iter = 100, 
                      conserve = TRUE, #conservative variance of the test statistics 
                      alpha = 0.05,
                      verbose=TRUE,
                      global=FALSE)})

save(ancom, file = "./Results/03_differential_abundance/ancom_16S.Rdata")

```

Get results 
```{r}

head(ancom$cond_phytohormones$feature_table)

#check
lapply(ancom, function(ancom_result){head(ancom_result$res$lfc)})#LFC
lapply(ancom, function(ancom_result){head(ancom_result$res$se)})#standard error
lapply(ancom, function(ancom_result){head(ancom_result$res$W)}) #test statistic LFC/se

#get sample fractions
samp_frac <- lapply(ancom, function(ancom_result){ancom_result$samp_frac})#ancom$samp_frac

# Get log transformed counts and add pseudo-count (1) to feature table to avoid taking the log of 0
log_obs_abn <-lapply(ancom, function(ancom_result){log(ancom_result$feature_table +1)})

# Adjust the log observed abundances with the sample fraction
log_corr_abn <-mapply(function(x,y){
                     t(t(x) - y)},
                     x=log_obs_abn,
                     y=samp_frac)
  
#Results
log_corr_abn #bias-corrected log abundances
lfc <- lapply(ancom, function(ancom_result){ancom_result$res$lfc}) #log-fold change according to control 
se_lfc <- lapply(ancom, function(ancom_result){ancom_result$res$se}) #standard error of log-fold change

#get significant ASVs   
JA_asvs <- lapply(ancom, function(ancom_result){
           asvs <- ancom_result$res$diff_abn %>%
            dplyr::filter(plant_pathway_inducedJA == TRUE) #26,12,8
           asvs$ASV <- asvs$taxon
           return(asvs)})

SA_asvs <- lapply(ancom, function(ancom_result){
           asvs <- ancom_result$res$diff_abn %>%
            dplyr::filter(plant_pathway_inducedSA == TRUE) #9,4,10
           asvs$ASV <- asvs$taxon
           return(asvs)})

#Now I need to get the unique names 
sig_asvs <- mapply(function(x,y){
  c(x$ASV, y$ASV)},
  x=JA_asvs,
  y=SA_asvs)

#make it into a dataframe format
sig_asvs <- lapply(sig_asvs, function(x){
   unique <- unique(x)
   unique <- as.data.frame(unique)
   colnames(unique) <- "ASV"
   return(unique)})  

#With this I can slice the different data frames to plot them

#1.bias-corrected abundances
log_corr_abn_sig <- mapply(function(x,y){x[y$ASV,]},
  x=log_corr_abn,
  y=sig_asvs) #works because its a matrix 

#2.log-fold change vs controls
lfc_sig <- mapply(function(x,y){x[x$taxon %in% y$ASV,]},
                  x=lfc,
                  y=sig_asvs,
                  SIMPLIFY = FALSE) #to keep it as a list and not a single thing

#3.Differential abundance according to stress 
dif_abun_stress_sig <- mapply(function(x,y){x$res$diff_abn[x$res$diff_abn$taxon %in% y$ASV,]},
                           x=ancom,
                           y=sig_asvs,
                           SIMPLIFY = FALSE) 

#place ASV as rowname to avoid mistakes later
dif_abun_stress_sig <- lapply(dif_abun_stress_sig, function(df){
  rownames(df) <- df$taxon
  df <- df[,3:4]
  return(df)
})

```

##Heatmap LFC by treatment

To make my life easier I'll plot one per experiment and just run the same code 

###Phyto
```{r}

#I need:
lfc_sig$cond_phytohormones #values of lfc 
dif_abun_stress_sig$cond_phytohormones #info if DA in JA and/or SA
ps_16S_split$cond_phytohormones #phyloseq

#change name to run the same code 
lfc <- lfc_sig$cond_phytohormones
dif_abun_stress <- dif_abun_stress_sig$cond_phytohormones

#let's plot only the LFC 

#Now, let's see what happens when the LFC results from ANCOMBC are plotted in a heatmap
rownames(lfc) <- lfc$taxon
lfc <- lfc[,3:4]

#make a matrix from the lfc differences
matrix.log.phyto <- as.matrix(lfc) 

#make new ps with only the DA asvs
ps_DA <- phyloseq::prune_taxa(sig_asvs$cond_phytohormones$ASV, ps_16S_split$cond_phytohormones)

#get species name if available, if not replace with name of ASV
df_row <- as.data.frame((tax_table(ps_DA))[, c("Genus")])
df_row <- df_row %>%
           mutate(asv_name=rownames(.)) #new column with rownames
df_row$Genus <- ifelse(is.na(df_row$Genus), df_row$asv_name, df_row$Genus)
df_row <- df_row %>%
           dplyr::select(Genus)

#order data so it matches
dif_abun_stress_ordered <- dif_abun_stress[order(match(rownames(dif_abun_stress),
                                                     rownames(tax_table(ps_DA)))), , drop=FALSE] 

matrix.log.phyto_ordered <- matrix.log.phyto[order(match(rownames(matrix.log.phyto),
                                                     rownames(tax_table(ps_DA)))), , drop=FALSE] 

#define annotation for rows
annotation_row = data.frame(
    Phylum = as.factor(tax_table(ps_DA)[, "Phylum"]), #to add phylum in the heatmap as well
    Contrast = dif_abun_stress_ordered) 
colnames(annotation_row)[2:3] <- c("JAvsCtrl", "SAvsCtrl")

#change it to factor so it can be colored
annotation_row$JAvsCtrl <- as.factor(annotation_row$JAvsCtrl)
annotation_row$SAvsCtrl <- as.factor(annotation_row$SAvsCtrl)

#check if rownames are in same order 
rownames(tax_table(ps_DA)) #annotation row
rownames(df_row) #yes

#check if names are the same 
rownames(matrix.log.phyto_ordered)
rownames(annotation_row) #yes

#make labels for rows 
df_row
species_ordered <- df_row[order(match(rownames(df_row), rownames(matrix.log.phyto_ordered))), , drop = FALSE]

# select colors for factors
#make colors for phylum with custom function
colourCount <- length(levels(annotation_row$Phylum))
getPalette <- colorRampPalette(brewer.pal(colourCount, "Set3"))

#apply to phylum
phylum_col = getPalette(colourCount)
names(phylum_col) = levels(annotation_row$Phylum)
names(color_experiment) = c("cond_phytohormones", "real_insects")

#put all colors together
annotation_colors = list(
     Phylum = phylum_col,
     JAvsCtrl = c("TRUE" = "#E69F00", "FALSE" = "white"),
     SAvsCtrl = c("TRUE" = "#4472C4", "FALSE" = "white"),
     Experiment = color_experiment)

#make colors for matrix
#Select colors for the ends of the values and the middle 
function_color_matrix <- circlize::colorRamp2(c(-2.5, 0, 2.5),
                          c("#0088c9",  "white", "#c85200"))
                         # c("#0000FF", "white", "#FF0000")) #palette blue/red
                         # c("#018571", "white", "#A6611A")) #palette teal/brown

function_color_matrix(seq(-3,3)) #gives you 9 colors with white in the middle 

# now plot the pheatmap
lfc_heatmap <- ComplexHeatmap::pheatmap(matrix.log.phyto_ordered,
                         color= function_color_matrix,
                         name="LFC",
                         scale= "none", 
                         row_labels = species_ordered$Genus,
                         #annotation_col = annotation_col, 
                         annotation_row = annotation_row, 
                         annotation_colors = annotation_colors,
                         cluster_cols = FALSE,
                         cluster_rows = TRUE,
                         main = "Phytohormones",
                         fontsize_row = 8,
                         fontsize_col = 8)
#view
lfc_heatmap

#save by hand with dimensions: 784x634 px 

```






###Insects
```{r}

#I need:
lfc_sig$cond_real_insects #values of lfc 
dif_abun_stress_sig$cond_real_insects #info if DA in JA and/or SA
ps_16S_split$cond_real_insects #phyloseq

#change name to run the same code 
lfc <- lfc_sig$cond_real_insects
dif_abun_stress <- dif_abun_stress_sig$cond_real_insects

#let's plot only the LFC 

#Now, let's see what happens when the LFC results from ANCOMBC are plotted in a heatmap
rownames(lfc) <- lfc$taxon
lfc <- lfc[,3:4]

#make a matrix from the lfc differences
matrix.log.insects <- as.matrix(lfc) 

#make new ps with only the DA asvs
ps_DA <- phyloseq::prune_taxa(sig_asvs$cond_real_insects$ASV, ps_16S_split$cond_real_insects)

#get species name if available, if not replace with name of ASV
df_row <- as.data.frame((tax_table(ps_DA))[, c("Genus")])
df_row <- df_row %>%
           mutate(asv_name=rownames(.)) #new column with rownames
df_row$Genus <- ifelse(is.na(df_row$Genus), df_row$asv_name, df_row$Genus)
df_row <- df_row %>%
           dplyr::select(Genus)

#order data so it matches
dif_abun_stress_ordered <- dif_abun_stress[order(match(rownames(dif_abun_stress),
                                                     rownames(tax_table(ps_DA)))), , drop=FALSE] 

matrix.log.insects_ordered <- matrix.log.insects[order(match(rownames(matrix.log.insects),
                                                     rownames(tax_table(ps_DA)))), , drop=FALSE] 

#define annotation for rows
annotation_row = data.frame(
    Phylum = as.factor(tax_table(ps_DA)[, "Phylum"]), #to add phylum in the heatmap as well
    Contrast = dif_abun_stress_ordered) 
colnames(annotation_row)[2:3] <- c("JAvsCtrl", "SAvsCtrl")

#change it to factor so it can be colored
annotation_row$JAvsCtrl <- as.factor(annotation_row$JAvsCtrl)
annotation_row$SAvsCtrl <- as.factor(annotation_row$SAvsCtrl)

#check if rownames are in same order 
rownames(tax_table(ps_DA)) #annotation row
rownames(df_row) #yes

#check if names are the same 
rownames(matrix.log.phyto_ordered)
rownames(annotation_row) #yes

#make labels for rows 
df_row
species_ordered <- df_row[order(match(rownames(df_row), rownames(matrix.log.insects_ordered))), , drop = FALSE]

# select colors for factors
#make colors for phylum with custom function
colourCount <- length(levels(annotation_row$Phylum))
getPalette <- colorRampPalette(brewer.pal(colourCount, "Set3"))

#apply to phylum
phylum_col = getPalette(colourCount)
names(phylum_col) = levels(annotation_row$Phylum)
names(color_experiment) = c("cond_phytohormones", "real_insects")

#put all colors together
annotation_colors = list(
     Phylum = phylum_col,
     JAvsCtrl = c("TRUE" = "#E69F00", "FALSE" = "white"),
     SAvsCtrl = c("TRUE" = "#4472C4", "FALSE" = "white"),
     Experiment = color_experiment)

#make colors for matrix
#Select colors for the ends of the values and the middle 
function_color_matrix <- circlize::colorRamp2(c(-2.5, 0, 2.5),
                          c("#0088c9",  "white", "#c85200"))
                         # c("#0000FF", "white", "#FF0000")) #palette blue/red
                         # c("#018571", "white", "#A6611A")) #palette teal/brown

function_color_matrix(seq(-3,3)) #gives you 9 colors with white in the middle 

# now plot the pheatmap
lfc_heatmap <- ComplexHeatmap::pheatmap(matrix.log.insects_ordered,
                         color= function_color_matrix,
                         name="LFC",
                         scale= "none", 
                         row_labels = species_ordered$Genus,
                         #annotation_col = annotation_col, 
                         annotation_row = annotation_row, 
                         annotation_colors = annotation_colors,
                         cluster_cols = FALSE,
                         cluster_rows = TRUE,
                         main = "Insect Herbivory",
                         fontsize_row = 8,
                         fontsize_col = 8)
#view
lfc_heatmap

#save by hand with dimensions: 784x634 px 

```

###EPG
```{r}

#I need:
lfc_sig$EPG #values of lfc 
dif_abun_stress_sig$EPG #info if DA in JA and/or SA
ps_16S_split$EPG #phyloseq

#change name to run the same code 
lfc <- lfc_sig$EPG
dif_abun_stress <- dif_abun_stress_sig$EPG

#let's plot only the LFC 

#Now, let's see what happens when the LFC results from ANCOMBC are plotted in a heatmap
rownames(lfc) <- lfc$taxon
lfc <- lfc[,3:4]

#make a matrix from the lfc differences
matrix.log.EPG <- as.matrix(lfc) 

#make new ps with only the DA asvs
ps_DA <- phyloseq::prune_taxa(sig_asvs$EPG$ASV, ps_16S_split$EPG)

#get species name if available, if not replace with name of ASV
df_row <- as.data.frame((tax_table(ps_DA))[, c("Genus")])
df_row <- df_row %>%
           mutate(asv_name=rownames(.)) #new column with rownames
df_row$Genus <- ifelse(is.na(df_row$Genus), df_row$asv_name, df_row$Genus)
df_row <- df_row %>%
           dplyr::select(Genus)

#order data so it matches
dif_abun_stress_ordered <- dif_abun_stress[order(match(rownames(dif_abun_stress),
                                                     rownames(tax_table(ps_DA)))), , drop=FALSE] 

matrix.log.EPG_ordered <- matrix.log.EPG[order(match(rownames(matrix.log.EPG),
                                                     rownames(tax_table(ps_DA)))), , drop=FALSE] 

#define annotation for rows
annotation_row = data.frame(
    Phylum = as.factor(tax_table(ps_DA)[, "Phylum"]), #to add phylum in the heatmap as well
    Contrast = dif_abun_stress_ordered) 
colnames(annotation_row)[2:3] <- c("JAvsCtrl", "SAvsCtrl")

#change it to factor so it can be colored
annotation_row$JAvsCtrl <- as.factor(annotation_row$JAvsCtrl)
annotation_row$SAvsCtrl <- as.factor(annotation_row$SAvsCtrl)

#check if rownames are in same order 
rownames(tax_table(ps_DA)) #annotation row
rownames(df_row) #yes

#check if names are the same 
rownames(matrix.log.EPG_ordered)
rownames(annotation_row) #yes

#make labels for rows 
df_row
species_ordered <- df_row[order(match(rownames(df_row), rownames(matrix.log.EPG_ordered))), , drop = FALSE]

# select colors for factors
#make colors for phylum with custom function
colourCount <- length(levels(annotation_row$Phylum))
getPalette <- colorRampPalette(brewer.pal(colourCount, "Set3"))

#apply to phylum
phylum_col = getPalette(colourCount)
names(phylum_col) = levels(annotation_row$Phylum)
names(color_experiment) = c("cond_phytohormones", "real_insects")

#put all colors together
annotation_colors = list(
     Phylum = phylum_col,
     JAvsCtrl = c("TRUE" = "#E69F00", "FALSE" = "white"),
     SAvsCtrl = c("TRUE" = "#4472C4", "FALSE" = "white"),
     Experiment = color_experiment)

#make colors for matrix
#Select colors for the ends of the values and the middle 
function_color_matrix <- circlize::colorRamp2(c(-2.5, 0, 2.5),
                          c("#0088c9",  "white", "#c85200"))
                         # c("#0000FF", "white", "#FF0000")) #palette blue/red
                         # c("#018571", "white", "#A6611A")) #palette teal/brown

function_color_matrix(seq(-3,3)) #gives you 9 colors with white in the middle 

# now plot the pheatmap
lfc_heatmap <- ComplexHeatmap::pheatmap(matrix.log.EPG_ordered,
                         color= function_color_matrix,
                         name="LFC",
                         scale= "none", 
                         row_labels = species_ordered$Genus,
                         #annotation_col = annotation_col, 
                         annotation_row = annotation_row, 
                         annotation_colors = annotation_colors,
                         cluster_cols = FALSE,
                         cluster_rows = TRUE,
                         main = "EPG",
                         fontsize_row = 8,
                         fontsize_col = 8)
#view
lfc_heatmap

#save by hand with dimensions: 784x634 px 

```

##Summary







#ITS

```{r}

#First, save results
save.image(file="./R_Environments/03_differential_abundance/heatmap_16S.RData")

#remove everything but functions and colors for plots
rm(list=ls())
gc()

#Load ITS data

#ITS
load(file = "./amplicon_data/Phyloseq_objects/ps_ITS_split.RData")
ps_ITS_split

```


##Pre-filtering

```{r}
#First, make a pre-filtering of those taxa that are low in prevalence (<20%)

ps_ITS_filt <- lapply(ps_ITS_split, function(ps){
  metagMisc::phyloseq_filter_prevalence(ps, prev.trh = 0.10, #at least 20% of samples
                                          abund.trh = NULL) #no filtering by abundance
})

#check
ps_ITS_filt #less than 150 taxa, better to use 10% prevalence filter 

#clean
rm(ps_ITS_filt)

```

##ANCOM
```{r}

ancom <- lapply(ps_ITS_split, function(ps){
  set.seed(123)
  ANCOMBC::ancombc(phyloseq = ps, 
                      formula = "plant_pathway_induced", 
                      p_adj_method = "fdr", #same as "BH" Benjamini & Hochberg
                      prv_cut = 0.10,
                      group = "plant_pathway_induced", 
                      struc_zero = TRUE, #with structural zero's
                      neg_lb = FALSE, #classifies structural zero's if it's zero and not its asymptotic lower bound 
                      tol = 1e-5,               
                      max_iter = 100, 
                      conserve = TRUE, #conservative variance of the test statistics 
                      alpha = 0.05,
                      verbose=TRUE,
                      global=FALSE)})

save(ancom, file = "./Results/03_differential_abundance/ancom_ITS.Rdata")

```

Get results 
```{r}

head(ancom$cond_phytohormones$feature_table)

#check
lapply(ancom, function(ancom_result){head(ancom_result$res$lfc)})#LFC
lapply(ancom, function(ancom_result){head(ancom_result$res$se)})#standard error
lapply(ancom, function(ancom_result){head(ancom_result$res$W)}) #test statistic LFC/se

#get sample fractions
samp_frac <- lapply(ancom, function(ancom_result){ancom_result$samp_frac})#ancom$samp_frac

# Get log transformed counts and add pseudo-count (1) to feature table to avoid taking the log of 0
log_obs_abn <-lapply(ancom, function(ancom_result){log(ancom_result$feature_table +1)})

# Adjust the log observed abundances with the sample fraction
log_corr_abn <-mapply(function(x,y){
                     t(t(x) - y)},
                     x=log_obs_abn,
                     y=samp_frac)
  
#Results
log_corr_abn #bias-corrected log abundances
lfc <- lapply(ancom, function(ancom_result){ancom_result$res$lfc}) #log-fold change according to control 
se_lfc <- lapply(ancom, function(ancom_result){ancom_result$res$se}) #standard error of log-fold change

#get significant ASVs   
JA_asvs <- lapply(ancom, function(ancom_result){
           asvs <- ancom_result$res$diff_abn %>%
            dplyr::filter(plant_pathway_inducedJA == TRUE) #26,12,8
           asvs$ASV <- asvs$taxon
           return(asvs)})

SA_asvs <- lapply(ancom, function(ancom_result){
           asvs <- ancom_result$res$diff_abn %>%
            dplyr::filter(plant_pathway_inducedSA == TRUE) #9,4,10
           asvs$ASV <- asvs$taxon
           return(asvs)})

#Now I need to get the unique names 
sig_asvs <- mapply(function(x,y){
  c(x$ASV, y$ASV)},
  x=JA_asvs,
  y=SA_asvs)

#make it into a dataframe format
sig_asvs <- lapply(sig_asvs, function(x){
   unique <- unique(x)
   unique <- as.data.frame(unique)
   colnames(unique) <- "ASV"
   return(unique)})  

#With this I can slice the different data frames to plot them

#1.bias-corrected abundances
log_corr_abn_sig <- mapply(function(x,y){x[y$ASV,]},
  x=log_corr_abn,
  y=sig_asvs) #works because its a matrix 

#2.log-fold change vs controls
lfc_sig <- mapply(function(x,y){x[x$taxon %in% y$ASV,]},
                  x=lfc,
                  y=sig_asvs,
                  SIMPLIFY = FALSE) #to keep it as a list and not a single thing

#3.Differential abundance according to stress 
dif_abun_stress_sig <- mapply(function(x,y){x$res$diff_abn[x$res$diff_abn$taxon %in% y$ASV,]},
                           x=ancom,
                           y=sig_asvs,
                           SIMPLIFY = FALSE) 

#place ASV as rowname to avoid mistakes later
dif_abun_stress_sig <- lapply(dif_abun_stress_sig, function(df){
  rownames(df) <- df$taxon
  df <- df[,3:4]
  return(df)
})



```

##Euler diagrams
Check it with an Euler diagram
```{r}

library(eulerr)

#First, arrange the data
JA_asvs$cond_phytohormones$ASV
SA_asvs$cond_phytohormones$ASV


phyto <- list(
           JA = JA_asvs$cond_phytohormones$ASV,
           SA = SA_asvs$cond_phytohormones$ASV)

insects <- list(
           JA = JA_asvs$cond_real_insects$ASV,
           SA = SA_asvs$cond_real_insects$ASV)

EPG <- list(
           JA = JA_asvs$EPG$ASV,
           SA = SA_asvs$EPG$ASV)

da_list <- list(phyto=phyto, insects=insects, EPG=EPG)

#calculate overlapp
venn_df <- lapply(da_list, function(list){
  calculate.overlap(list)})
  
#get numbers 
euler <- lapply(venn_df, function(list){
  #get length
  JA <- length(list$a1)
  SA <- length(list$a2)
  JA_SA <- length(list$a3)
  
  list <- list(JA=JA, SA=SA, JA_SA=JA_SA)
  return(list)
})

#plot it
venn_phyto <- draw.pairwise.venn(area1=euler$phyto$JA,
                                 area2=euler$phyto$SA,
                                 cross.area=euler$phyto$JA_SA,
                   euler.d = TRUE,
                   scaled = TRUE,
                   ext.text = FALSE,
                   #category=c("JA", "SA"),
                   lty = 1, #outline
                   col = c(color_JA, color_SA),
                   lwd=4,
                   #ext.line.lwd = 0.5,
                   fill = c(color_JA, color_SA), #color of area
                   cex=1.5, #size of labels
                   alpha = rep(0.8, 2), #transparency of color
                   cat.pos = 0,
                   cat.dist = 0,
                   fontfamily = fonts$sans,
                   cat.fontfamily = fonts$sans,
                   inverted = FALSE,
                   print.mode = c("raw", "percent"),
                   rotation.degree = 0)

#save it by hand 500x500 px

venn_insects <- draw.pairwise.venn(area1=euler$insects$JA,
                                 area2=euler$insects$SA,
                                 cross.area=euler$insects$JA_SA,
                   euler.d = TRUE,
                   scaled = TRUE,
                   ext.text = FALSE,
                   #category=c("JA", "SA"),
                   lty = 1, #outline
                   col = c(color_JA, color_SA),
                   lwd=4,
                   #ext.line.lwd = 0.5,
                   fill = c(color_JA, color_SA), #color of area
                   cex=1.5, #size of labels
                   alpha = rep(0.8, 2), #transparency of color
                   cat.pos = 0,
                   cat.dist = 0,
                   fontfamily = fonts$sans,
                   cat.fontfamily = fonts$sans,
                   inverted = FALSE,
                   print.mode = c("raw", "percent"),
                   rotation.degree = 0)


venn_EPG <- draw.pairwise.venn(area1=euler$EPG$JA,
                                 area2=euler$EPG$SA,
                                 cross.area=euler$EPG$JA_SA,
                   euler.d = TRUE,
                   scaled = TRUE,
                   ext.text = FALSE,
                   #category=c("JA", "SA"),
                   lty = 1, #outline
                   col = c(color_JA, color_SA),
                   lwd=4,
                   #ext.line.lwd = 0.5,
                   fill = c(color_JA, color_SA), #color of area
                   cex=1.5, #size of labels
                   alpha = rep(0.8, 2), #transparency of color
                   cat.pos = 0,
                   cat.dist = 0,
                   fontfamily = fonts$sans,
                   cat.fontfamily = fonts$sans,
                   inverted = FALSE,
                   print.mode = c("raw", "percent"),
                   rotation.degree = 0)

#clean
rm(venn_phyto, venn_insects, venn_EPG, euler, venn_df)

```

##Heatmap LFC by treatment

To make my life easier I'll plot one per experiment and just run the same code 

###Phyto


```{r}

#I need:
lfc_sig$cond_phytohormones #values of lfc 
dif_abun_stress_sig$cond_phytohormones #info if DA in JA and/or SA
ps_ITS_split$cond_phytohormones #phyloseq

#change name to run the same code 
lfc <- lfc_sig$cond_phytohormones
dif_abun_stress <- dif_abun_stress_sig$cond_phytohormones

#let's plot only the LFC 

#Now, let's see what happens when the LFC results from ANCOMBC are plotted in a heatmap
rownames(lfc) <- lfc$taxon
lfc <- lfc[,3:4]

#make a matrix from the lfc differences
matrix.log.phyto <- as.matrix(lfc) 

#make new ps with only the DA asvs
ps_DA <- phyloseq::prune_taxa(sig_asvs$cond_phytohormones$ASV, ps_ITS_split$cond_phytohormones)

#get species name if available, if not replace with name of ASV
df_row <- as.data.frame((tax_table(ps_DA))[, c("Genus")])
df_row <- df_row %>%
           mutate(asv_name=rownames(.)) #new column with rownames
df_row$Genus <- ifelse(is.na(df_row$Genus), df_row$asv_name, df_row$Genus)
df_row <- df_row %>%
           dplyr::select(Genus)

#get life-guild trait if available
df_guild <- as.data.frame((tax_table(ps_DA))[,c("Trophic.Mode")])
df_guild <- df_guild %>% 
            mutate(asv_name=rownames(.))
df_guild$Trophic.Mode <- ifelse(df_guild$Trophic.Mode == "-", 'unknown', df_guild$Trophic.Mode)

#order data so it matches
dif_abun_stress_ordered <- dif_abun_stress[order(match(rownames(dif_abun_stress),
                                                     rownames(tax_table(ps_DA)))), , drop=FALSE] 

matrix.log.phyto_ordered <- matrix.log.phyto[order(match(rownames(matrix.log.phyto),
                                                     rownames(tax_table(ps_DA)))), , drop=FALSE] 

#define annotation for rows
annotation_row = data.frame(
    Phylum = as.factor(tax_table(ps_DA)[, "Phylum"]), #to add phylum in the heatmap as well
    Guild = as.factor(tax_table(ps_DA)[, "Trophic.Mode"]),
    Contrast = dif_abun_stress_ordered) 
colnames(annotation_row)[3:4] <- c("JAvsCtrl", "SAvsCtrl")

#change it to factor so it can be colored
annotation_row$JAvsCtrl <- as.factor(annotation_row$JAvsCtrl)
annotation_row$SAvsCtrl <- as.factor(annotation_row$SAvsCtrl)

#check if rownames are in same order 
rownames(tax_table(ps_DA)) #annotation row
rownames(df_row) #yes

#check if names are the same 
rownames(matrix.log.phyto_ordered)
rownames(annotation_row) #yes

#make labels for rows 
df_row
species_ordered <- df_row[order(match(rownames(df_row), rownames(matrix.log.phyto_ordered))), , drop = FALSE]

# select colors for factors
#make colors for phylum with custom function
colourCount <- length(levels(annotation_row$Phylum))
getPalette <- colorRampPalette(brewer.pal(colourCount, "Set3"))

#apply to phylum
phylum_col = getPalette(colourCount)
names(phylum_col) = levels(annotation_row$Phylum)

#apply to guild
colourCount <- length(levels(annotation_row$Guild))
getPalette <- colorRampPalette(brewer.pal(colourCount, "Paired"))
getPalette(colourCount)
guild_colors <- c("#A6CEE3", "#1F78B4", "#B2DF8A", "#33A02C", "#FB9A99", "#E31A1C", "#FDBF6F")
levels(annotation_row$Guild)
guild_colors <- c("gray","#E31A1C", "#FDBF6F", "#A6CEE3", "#1F78B4", "#B2DF8A", "#33A02C")
names(guild_colors) <- levels(annotation_row$Guild)

#change name of experiment so it works
names(color_experiment) = c("cond_phytohormones", "real_insects")

#put all colors together
annotation_colors = list(
     Phylum = phylum_col,
     Guild = guild_colors,
     JAvsCtrl = c("TRUE" = "#E69F00", "FALSE" = "white"),
     SAvsCtrl = c("TRUE" = "#4472C4", "FALSE" = "white"),
     Experiment = color_experiment)

#make colors for matrix
#Select colors for the ends of the values and the middle 
function_color_matrix <- circlize::colorRamp2(c(-2.5, 0, 2.5),
                          c("#0088c9",  "white", "#c85200"))
                         # c("#0000FF", "white", "#FF0000")) #palette blue/red
                         # c("#018571", "white", "#A6611A")) #palette teal/brown

function_color_matrix(seq(-3,3)) #gives you 9 colors with white in the middle 

# now plot the pheatmap
lfc_heatmap <- ComplexHeatmap::pheatmap(matrix.log.phyto_ordered,
                         color= function_color_matrix,
                         name="LFC",
                         scale= "none", 
                         row_labels = species_ordered$Genus,
                         #annotation_col = annotation_col, 
                         annotation_row = annotation_row, 
                         annotation_colors = annotation_colors,
                         cluster_cols = FALSE,
                         cluster_rows = TRUE,
                         main = "Phytohormones-ITS",
                         fontsize_row = 8,
                         fontsize_col = 8)
#view
lfc_heatmap

#save by hand with dimensions: 784x634 px 

```

Save data
```{r}

ancom.p <- ancom$cond_phytohormones #ancom results
lfc  #lfc values  
asvs <- sig_asvs$cond_phytohormones$ASV #vector with ASV names 
dif_abun_stress #contains whether TRUE or FALSE for JA and SA 
log_corr_abn <- log_corr_abn_sig$cond_phytohormones #corrected abundances of DA ASVs
ps_DA #ps with info

#make it into a list  
phyto_dataDA <- list (ancom_test=ancom.p, lfc=lfc, sig_asvs=asvs,
                    binary_stress=dif_abun_stress, log_corr_abn=log_corr_abn,
                    ps=ps_DA)

#save it
save(phyto_dataDA, file="./Results/03_differential_abundance/phyto_dataDA.Rdata")

#clean
rm.all.but(keep=c("insects", "EPG", "ancom", "sig_asvs", "dif_abun_stress_sig", "lfc_sig",
                  "log_corr_abn_sig", "ps_ITS_split" ), keep_functions = F)

```

###Insects
```{r}

#I need:
lfc_sig$cond_real_insects #values of lfc 
dif_abun_stress_sig$cond_real_insects #info if DA in JA and/or SA
ps_ITS_split$cond_real_insects #phyloseq

#change name to run the same code 
lfc <- lfc_sig$cond_real_insects
dif_abun_stress <- dif_abun_stress_sig$cond_real_insects

#let's plot only the LFC 

#Now, let's see what happens when the LFC results from ANCOMBC are plotted in a heatmap
rownames(lfc) <- lfc$taxon
lfc <- lfc[,3:4]

#make a matrix from the lfc differences
matrix.log.insects <- as.matrix(lfc) 

#make new ps with only the DA asvs
ps_DA <- phyloseq::prune_taxa(sig_asvs$cond_real_insects$ASV, ps_ITS_split$cond_real_insects)

#get species name if available, if not replace with name of ASV
df_row <- as.data.frame((tax_table(ps_DA))[, c("Genus")])
df_row <- df_row %>%
           mutate(asv_name=rownames(.)) #new column with rownames
df_row$Genus <- ifelse(is.na(df_row$Genus), df_row$asv_name, df_row$Genus)
df_row <- df_row %>%
           dplyr::select(Genus)

#order data so it matches
dif_abun_stress_ordered <- dif_abun_stress[order(match(rownames(dif_abun_stress),
                                                     rownames(tax_table(ps_DA)))), , drop=FALSE] 

matrix.log.insects_ordered <- matrix.log.insects[order(match(rownames(matrix.log.insects),
                                                     rownames(tax_table(ps_DA)))), , drop=FALSE] 

#define annotation for rows
annotation_row = data.frame(
    Phylum = as.factor(tax_table(ps_DA)[, "Phylum"]), #to add phylum in the heatmap as well
    Guild = as.factor(tax_table(ps_DA)[, "Trophic.Mode"]),
    Contrast = dif_abun_stress_ordered) 
colnames(annotation_row)[3:4] <- c("JAvsCtrl", "SAvsCtrl")

#change it to factor so it can be colored
annotation_row$JAvsCtrl <- as.factor(annotation_row$JAvsCtrl)
annotation_row$SAvsCtrl <- as.factor(annotation_row$SAvsCtrl)

#check if rownames are in same order 
rownames(tax_table(ps_DA)) #annotation row
rownames(df_row) #yes

#check if names are the same 
rownames(matrix.log.insects_ordered)
rownames(annotation_row) #yes

#make labels for rows 
df_row
species_ordered <- df_row[order(match(rownames(df_row), rownames(matrix.log.insects_ordered))), , drop = FALSE]

# select colors for factors
#make colors for phylum with custom function
colourCount <- length(levels(annotation_row$Phylum))
getPalette <- colorRampPalette(brewer.pal(colourCount, "Set3"))

#apply to phylum
phylum_col <- getPalette(colourCount)
phylum_col <- c("#8DD3C7", "#BEBADA")
names(phylum_col) = levels(annotation_row$Phylum)

#apply to guild
colourCount <- length(levels(annotation_row$Guild))
getPalette <- colorRampPalette(brewer.pal(colourCount, "Paired"))
getPalette(colourCount)
guild_colors <- c("#A6CEE3", "#1F78B4", "#B2DF8A", "#33A02C", "#FB9A99", "#E31A1C", "#FDBF6F")
levels(annotation_row$Guild)
guild_colors <- c("gray","#E31A1C", "#FDBF6F", "#A6CEE3", "#1F78B4", "#B2DF8A", "#33A02C")
names(guild_colors) <- levels(annotation_row$Guild)

#change name of experiment so it works
color_experiment <- c("#CC3399", "#70AD47")
names(color_experiment) = c("cond_phytohormones", "real_insects")

#put all colors together
annotation_colors = list(
     Phylum = phylum_col,
     Guild = guild_colors,
     JAvsCtrl = c("TRUE" = "#E69F00", "FALSE" = "white"),
     SAvsCtrl = c("TRUE" = "#4472C4", "FALSE" = "white"),
     Experiment = color_experiment)

#make colors for matrix
#Select colors for the ends of the values and the middle 
function_color_matrix <- circlize::colorRamp2(c(-2.5, 0, 2.5),
                          c("#0088c9",  "white", "#c85200"))

function_color_matrix(seq(-3,3)) #gives you 9 colors with white in the middle 

# now plot the pheatmap
lfc_heatmap <- ComplexHeatmap::pheatmap(matrix.log.insects_ordered,
                         color= function_color_matrix,
                         name="LFC",
                         scale= "none", 
                         row_labels = species_ordered$Genus,
                         #annotation_col = annotation_col, 
                         annotation_row = annotation_row, 
                         annotation_colors = annotation_colors,
                         cluster_cols = FALSE,
                         cluster_rows = TRUE,
                         main = "Insect Herbivory-ITS",
                         fontsize_row = 8,
                         fontsize_col = 8)
#view
lfc_heatmap

#save by hand with dimensions: 784x634 px 

```

Save data
```{r}

ancom.i <- ancom$cond_real_insects #ancom results
lfc  #lfc values  
asvs <- sig_asvs$cond_real_insects$ASV #vector with ASV names 
dif_abun_stress #contains whether TRUE or FALSE for JA and SA 
log_corr_abn <- log_corr_abn_sig$cond_real_insects #corrected abundances of DA ASVs
ps_DA #ps with info

#make it into a list  
insects_dataDA <- list (ancom_test=ancom.i, lfc=lfc, sig_asvs=asvs,
                    binary_stress=dif_abun_stress, log_corr_abn=log_corr_abn,
                    ps=ps_DA)

#save it
save(insects_dataDA, file="./Results/03_differential_abundance/insects_dataDA.Rdata")

#clean
rm.all.but(keep=c("EPG", "ancom", "sig_asvs", "dif_abun_stress_sig", "lfc_sig",
                  "log_corr_abn_sig", "ps_ITS_split"), keep_functions = F)

```


###EPG
```{r}

#I need:
lfc_sig$EPG #values of lfc 
dif_abun_stress_sig$EPG #info if DA in JA and/or SA
ps_ITS_split$EPG #phyloseq

#change name to run the same code 
lfc <- lfc_sig$EPG
dif_abun_stress <- dif_abun_stress_sig$EPG

#let's plot only the LFC 

#Now, let's see what happens when the LFC results from ANCOMBC are plotted in a heatmap
rownames(lfc) <- lfc$taxon
lfc <- lfc[,3:4]

#make a matrix from the lfc differences
matrix.log.EPG <- as.matrix(lfc) 

#make new ps with only the DA asvs
ps_DA <- phyloseq::prune_taxa(sig_asvs$EPG$ASV, ps_ITS_split$EPG)

#get species name if available, if not replace with name of ASV
df_row <- as.data.frame((tax_table(ps_DA))[, c("Genus")])
df_row <- df_row %>%
           mutate(asv_name=rownames(.)) #new column with rownames
df_row$Genus <- ifelse(is.na(df_row$Genus), df_row$asv_name, df_row$Genus)
df_row <- df_row %>%
           dplyr::select(Genus)

#order data so it matches
dif_abun_stress_ordered <- dif_abun_stress[order(match(rownames(dif_abun_stress),
                                                     rownames(tax_table(ps_DA)))), , drop=FALSE] 

matrix.log.EPG_ordered <- matrix.log.EPG[order(match(rownames(matrix.log.EPG),
                                                     rownames(tax_table(ps_DA)))), , drop=FALSE] 

#define annotation for rows
annotation_row = data.frame(
    Phylum = as.factor(tax_table(ps_DA)[, "Phylum"]), #to add phylum in the heatmap as well
    Guild = as.factor(tax_table(ps_DA)[, "Trophic.Mode"]),
    Contrast = dif_abun_stress_ordered) 
colnames(annotation_row)[3:4] <- c("JAvsCtrl", "SAvsCtrl")

#change it to factor so it can be colored
annotation_row$JAvsCtrl <- as.factor(annotation_row$JAvsCtrl)
annotation_row$SAvsCtrl <- as.factor(annotation_row$SAvsCtrl)

#check if rownames are in same order 
rownames(tax_table(ps_DA)) #annotation row
rownames(df_row) #yes

#check if names are the same 
rownames(matrix.log.EPG_ordered)
rownames(annotation_row) #yes

#make labels for rows 
df_row
species_ordered <- df_row[order(match(rownames(df_row), rownames(matrix.log.EPG_ordered))), , drop = FALSE]

# select colors for factors
#make colors for phylum with custom function
colourCount <- length(levels(annotation_row$Phylum))
getPalette <- colorRampPalette(brewer.pal(colourCount, "Set3"))

#apply to phylum
phylum_col <- getPalette(colourCount)
phylum_col
phylum_col <- c("#8DD3C7",  "#FFFFB3",  "#FB8072", "#BEBADA","#80B1D3")
levels(annotation_row$Phylum)
names(phylum_col) = levels(annotation_row$Phylum)

#apply to guild
colourCount <- length(levels(annotation_row$Guild))
getPalette <- colorRampPalette(brewer.pal(colourCount, "Paired"))
getPalette(colourCount)
guild_colors <- c("#A6CEE3", "#1F78B4", "#B2DF8A", "#33A02C", "#FB9A99", "#E31A1C", "#FDBF6F")
levels(annotation_row$Guild)
guild_colors <- c("gray","#E31A1C", "#FDBF6F", "#A6CEE3", "#1F78B4", "#B2DF8A", "#33A02C")
names(guild_colors) <- levels(annotation_row$Guild)

#change name of experiment so it works
color_experiment <- c("#CC3399", "#70AD47")
names(color_experiment) = c("cond_phytohormones", "real_insects")

#put all colors together
annotation_colors = list(
     Phylum = phylum_col,
     Guild = guild_colors,
     JAvsCtrl = c("TRUE" = "#E69F00", "FALSE" = "white"),
     SAvsCtrl = c("TRUE" = "#4472C4", "FALSE" = "white"),
     Experiment = color_experiment)


#make colors for matrix
#Select colors for the ends of the values and the middle 
function_color_matrix <- circlize::colorRamp2(c(-2.5, 0, 2.5),
                          c("#0088c9",  "white", "#c85200"))

function_color_matrix(seq(-3,3)) #gives you 9 colors with white in the middle 

# now plot the pheatmap
lfc_heatmap <- ComplexHeatmap::pheatmap(matrix.log.EPG_ordered,
                         color= function_color_matrix,
                         name="LFC",
                         scale= "none", 
                         row_labels = species_ordered$Genus,
                         #annotation_col = annotation_col, 
                         annotation_row = annotation_row, 
                         annotation_colors = annotation_colors,
                         cluster_cols = FALSE,
                         cluster_rows = TRUE,
                         main = "EPG-ITS",
                         fontsize_row = 8,
                         fontsize_col = 8)
#view
lfc_heatmap

#save by hand with dimensions: 784x634 px 

```

Save data
```{r}

ancom.e <- ancom$EPG #ancom results
lfc  #lfc values  
asvs <- sig_asvs$EPG$ASV #vector with ASV names 
dif_abun_stress #contains whether TRUE or FALSE for JA and SA 
log_corr_abn <- log_corr_abn_sig$EPG #corrected abundances of DA ASVs
ps_DA #ps with info

#make it into a list  
epg_dataDA <- list (ancom_test=ancom.e, lfc=lfc, sig_asvs=asvs,
                    binary_stress=dif_abun_stress, log_corr_abn=log_corr_abn,
                    ps=ps_DA)

#save it
save(epg_dataDA, file="./Results/03_differential_abundance/EPG_dataDA_ITS.Rdata")

#clean
rm.all.but(keep=c("ps_ITS_split"), keep_functions = F)
gc()

```

##iTOL
```{r pruning ps}

#load full ITS ps, you'll need it to prune the tree from there 
load("./amplicon_data/Phyloseq_objects/ps_ITS.RData")

#load phyto data
#load insects data

#check name of ASVs to prune a ps 
p <- rownames(phyto_dataDA$ps@tax_table)
i <- rownames(insects_dataDA$ps@tax_table)

intersect <- intersect(p,i) #yes, in 3 of them
asvs <- c(p,i)
asvs <- unique(asvs) #58

#First, let's get the tree by pruning the original ps_16 with DA ASVs
#make ps with DA asvs
ps_DA <- prune_taxa(asvs, ps_ITS) #58 taxa, ok!
ITS_tree <- ps_DA@phy_tree
plot(ITS_tree)
ITS_tree$tip.label

#save it
ape::write.tree(ITS_tree, "./Results/03_differential_abundance/ITS_iTOL/ITS_DA_tree.tre")

```

Now, create a complete dataframe with all the info

```{r dataframe}

##let's get D1:Experiment
df.p <- as.data.frame(p) %>% 
         mutate(Phytohormones= "phytohormones")
colnames(df.p)[1] <-  "id"
  
df.i <- as.data.frame(i)%>% 
         mutate(Insects= "insects")
colnames(df.i)[1] <-  "id"

#merge
df_experiment <- full_join(df.p, df.i)
order_asvs <- df_experiment$id

#Add both, to those ASVs that are shared in a new column
#intersect #these are the ASVs that are in both 
#df_experiment <- df_experiment %>% mutate(Experiment_2=case_when(
#                                       id %in% intersect ~ "Both", TRUE ~ Experiment))
#rownames(df_experiment) 

#Now, let's get D2:LFC
#get LFC values from both experiments in a single df 
lfc_phyto <- phyto_dataDA$lfc %>%  mutate(Phytohormones= "phytohormones") %>% 
                                   rownames_to_column(var="id")
colnames(lfc_phyto) <- c("id", "lfc_JA_phyto", "lfc_SA_phyto", "Phytohormones")                              

lfc_insects <- insects_dataDA$lfc %>%  mutate(Insects= "insects") %>% 
                                   rownames_to_column(var="id")
colnames(lfc_insects) <- c("id", "lfc_JA_insects", "lfc_SA_insects", "Insects")  

#merge
df_lfc <- full_join(lfc_phyto, lfc_insects)
#df_lfc <- df_lfc %>% mutate(Experiment_2=case_when(
#                            id %in% intersect ~ "Both", TRUE ~ Experiment))


#Next, let's get D3:Treatment
#phyto
bin_phyto <- phyto_dataDA$binary_stress %>% rownames_to_column(var="id") %>% mutate(Phytohormones="phytohormones")
colnames(bin_phyto) <- c("id","DA_JA_phyto", "DA_SA_phyto", "Phytohormones")
bin_phyto <- bin_phyto %>% mutate(DA_JA_phyto = case_when(DA_JA_phyto == TRUE ~ "YES",
                                DA_JA_phyto == FALSE ~ "NO")) %>% 
                              mutate(DA_SA_phyto = case_when(DA_SA_phyto == TRUE ~ "YES",
                                DA_SA_phyto == FALSE ~ "NO"))
bin_phyto <- bin_phyto %>%
                mutate(DA_phyto = case_when(
                  DA_JA_phyto == "YES" & DA_SA_phyto == "NO" ~ "JA_Only",
                  DA_JA_phyto == "NO" & DA_SA_phyto == "YES" ~ "SA_Only",
                  DA_JA_phyto == "YES" & DA_SA_phyto == "YES" ~ "JA_and_SA")) #works

#insects
bin_insects <- insects_dataDA$binary_stress %>% rownames_to_column(var="id") %>% mutate(Insects="insects")
colnames(bin_insects) <- c("id","DA_JA_insects", "DA_SA_insects", "Insects")
bin_insects <- bin_insects %>% mutate(DA_JA_insects = case_when(DA_JA_insects == TRUE ~ "YES",
                                DA_JA_insects == FALSE ~ "NO")) %>% 
                              mutate(DA_SA_insects = case_when(DA_SA_insects == TRUE ~ "YES",
                                DA_SA_insects == FALSE ~ "NO"))
bin_insects <- bin_insects %>%
                mutate(DA_insects = case_when(
                  DA_JA_insects == "YES" & DA_SA_insects == "NO" ~ "JA_Only",
                  DA_JA_insects == "NO" & DA_SA_insects == "YES" ~ "SA_Only",
                  DA_JA_insects == "YES" & DA_SA_insects == "YES" ~ "JA_and_SA")) #works
  
#merge
binary_stress <- full_join(bin_phyto, bin_insects)
#binary_stress <- binary_stress %>% mutate(Experiment_2=case_when(
#                            id %in% intersect ~ "Both", TRUE ~ Experiment))

#merge
df_complete <- full_join(df_lfc, binary_stress)


#Finally, let's get taxonomy
#clean it first
tax_table(ps_DA)[, colnames(tax_table(ps_DA))] <- gsub(tax_table(ps_DA)[, colnames(tax_table(ps_DA))],     pattern = "[a-z]__", replacement = "")
#make it a df 
tax_table <- as.data.frame(ps_DA@tax_table[,c(1:7,12)]) #select the interesting ones 
tax_table$id <- rownames(tax_table) #add id column for join 

#merge
df_complete2 <- left_join(df_complete, tax_table)

#Now this df is complete (for now)

```

Move it into iTOL format

iTOL has a specific format to add data into the tree, it has to be in a .txt file and in a certain way coded. The package itol.toolkit helps to make an annotation file directly in R.


```{r color management}

#color management

#Set-up colors
color_JA <- "#E69F00"
color_SA <- "#4472C4"
color_experiment <- c("#CC3399", "#70AD47")

#Built in colors
display.brewer.all() #gives you the palettes from RColorBrewer

#I like Set3 palette, let's get one with 11 colors for Phylum
display.brewer.pal(n = 11, name = 'Set3') #nice

#make a vector with colors 
colourCount <- 11
getPalette <- colorRampPalette(brewer.pal(colourCount, "Set3"))
color_phylum <- getPalette(colourCount)


```



```{r Experiment}

#create Annotation files with using the itol.toolkit package

#Experiment: together
temp <- df_complete2%>%
        dplyr::select(c(id,))

## Experiment: Phyto
temp <- df_complete2%>%
        dplyr::select(c(id,Phytohormones))
temp$Phytohormones <- temp$Phytohormones %>% replace_na('No')

df_phyto <- data.frame(id = temp$id, 
                       data = temp$Phytohormones)

AF1 <- itol.toolkit::create_unit(data = df_phyto, 
                         key = "AF1_Experiment_Phytohormones", 
                         type = "DATASET_COLORSTRIP",
                         tree = ITS_tree)

temp_df <- AF1@data$tip 
temp_df2 <- temp_df %>%
          mutate(`AF1_Experiment_Phytohormones$COLOR` = case_when(
            `AF1_Experiment_Phytohormones$LABEL` == "phytohormones" ~"#CC3399",
            TRUE ~ "#FFFFFF"))

#substitute
AF1@data$tip <- temp_df2
#save
itol.toolkit::write_unit(AF1, "./Results/03_differential_abundance/ITS_iTOL")

## Experiment: Insects
temp <- df_complete2%>%
        dplyr::select(c(id,Insects))
temp$Insects <- temp$Insects %>% replace_na('No')

df_insects <- data.frame(id = temp$id, 
                       data = temp$Insects)

AF2 <- itol.toolkit::create_unit(data = df_insects, 
                         key = "AF2_Experiment_Insects", 
                         type = "DATASET_COLORSTRIP",
                         tree = ITS_tree)

temp_df <- AF2@data$tip 
temp_df2 <- temp_df %>%
          mutate(`AF2_Experiment_Insects$COLOR` = case_when(
            `AF2_Experiment_Insects$LABEL` == "insects" ~"#70AD47",
            TRUE ~ "#FFFFFF"))

#substitute
AF2@data$tip <- temp_df2
#save
itol.toolkit::write_unit(AF2, "./Results/03_differential_abundance/ITS_iTOL")

```

Treatment
```{r Treatment}
## Treatment
df_Treatment <- df_complete2%>%
                dplyr::select(id,DA_JA_phyto, DA_SA_phyto, DA_JA_insects, DA_SA_insects)%>%
                relocate(id)
#replace NA's
df_Treatment$DA_JA_phyto <- df_Treatment$DA_JA_phyto %>% replace_na('NO')
df_Treatment$DA_SA_phyto <- df_Treatment$DA_SA_phyto %>% replace_na('NO')
df_Treatment$DA_JA_insects <- df_Treatment$DA_JA_insects %>% replace_na('NO')
df_Treatment$DA_SA_insects <- df_Treatment$DA_SA_insects %>% replace_na('NO')

#replace 0's for -1 and Yes for 1 so iTOL recognizes full and empty symbols
df_Treatment2 <- df_Treatment %>% 
                mutate(DA_JA_phyto=case_when(DA_JA_phyto== "YES" ~ "1", TRUE ~ "-1")) %>% 
                mutate(DA_SA_phyto=case_when(DA_SA_phyto== "YES" ~ "1", TRUE ~ "-1")) %>%
                mutate(DA_JA_insects=case_when(DA_JA_insects== "YES" ~ "1", TRUE ~ "-1")) %>%
                mutate(DA_SA_insects=case_when(DA_SA_insects== "YES" ~ "1", TRUE ~ "-1"))

AF3 <- itol.toolkit::create_unit(data = df_Treatment2, 
                         key = "AF3_Treatment", 
                         type = "DATASET_BINARY",
                         tree = ITS_tree)

AF3@field$labels <- c("JA_phyto",   "SA_phyto",   "JA_insects", "SA_insects")
AF3@field$colors <- c("#E69F00", "#4472C4", "#E69F00", "#4472C4")

itol.toolkit::write_unit(AF3, "./Results/03_differential_abundance/ITS_iTOL")

#only phyto
df_Treatment3 <- df_Treatment2 %>% dplyr::select(c(id, DA_JA_phyto, DA_SA_phyto))

AF3.1 <- itol.toolkit::create_unit(data = df_Treatment3, 
                         key = "AF3_Treatment_Phyto", 
                         type = "DATASET_BINARY",
                         tree = ITS_tree)

AF3.1@field$labels <- c("JA_phyto",   "SA_phyto")
AF3.1@field$colors <- c("#E69F00", "#4472C4")

itol.toolkit::write_unit(AF3.1, "./Results/03_differential_abundance/ITS_iTOL")


#only insects
df_Treatment4 <- df_Treatment2 %>% dplyr::select(c(id, DA_JA_insects, DA_SA_insects))

AF3.2 <- itol.toolkit::create_unit(data = df_Treatment4, 
                         key = "AF3_Treatment_Insects", 
                         type = "DATASET_BINARY",
                         tree = ITS_tree)

AF3.2@field$labels <- c("JA_insects",   "SA_insects")
AF3.2@field$colors <- c("#E69F00", "#4472C4")

itol.toolkit::write_unit(AF3.2, "./Results/03_differential_abundance/ITS_iTOL")

```

LFC
```{r LFC-bars}
## LFC, phyto
df_LFC <- df_complete2%>%
                dplyr::select(id,lfc_JA_phyto, lfc_SA_phyto, lfc_JA_insects, lfc_SA_insects)%>%
                #mutate(id=rownames(.))%>%
                relocate(id)%>%
                as.tibble()

#let's round up
df_LFC <- df_LFC %>% 
          dplyr::mutate(across(where(is.numeric), round, 2))

#Let's try also with two independent bars, one for JA and one for SA
df_JA <- df_LFC %>%
          dplyr::select(id,lfc_JA_phyto)

#get Annotation 
AF4.1 <- itol.toolkit::create_unit(data = df_JA , 
                         key = "AF4.1_LFC_Phyto_JA", 
                         type = "DATASET_SIMPLEBAR",
                         tree = ITS_tree)

AF4.1@profile$color <- color_JA
itol.toolkit::write_unit(AF4.1, "./Results/03_differential_abundance/ITS_iTOL")


#Let's try also with two independent bars, one for JA and one for SA
df_SA <- df_LFC %>%
          dplyr::select(id,lfc_SA_phyto)

#get Annotation 
AF4.2 <- itol.toolkit::create_unit(data = df_SA , 
                         key = "AF4.2_LFC_Phyto_SA", 
                         type = "DATASET_SIMPLEBAR",
                         tree = ITS_tree)

AF4.2@profile$color <- color_SA

itol.toolkit::write_unit(AF4.2, "./Results/03_differential_abundance/ITS_iTOL")

#Insects
#Let's try also with two independent bars, one for JA and one for SA
df_JA <- df_LFC %>%
          dplyr::select(id,lfc_JA_insects)

#get Annotation 
AF4.3 <- itol.toolkit::create_unit(data = df_JA , 
                         key = "AF4.3_LFC_Insects_JA", 
                         type = "DATASET_SIMPLEBAR",
                         tree = ITS_tree)

AF4.3@profile$color <- color_JA
itol.toolkit::write_unit(AF4.3, "./Results/03_differential_abundance/ITS_iTOL")

#Let's try also with two independent bars, one for JA and one for SA
df_SA <- df_LFC %>%
          dplyr::select(id,lfc_SA_insects)

#get Annotation 
AF4.4 <- itol.toolkit::create_unit(data = df_SA , 
                         key = "AF4.4_LFC_Insects_SA", 
                         type = "DATASET_SIMPLEBAR",
                         tree = ITS_tree)

AF4.4@profile$color <- color_SA
itol.toolkit::write_unit(AF4.4, "./Results/03_differential_abundance/ITS_iTOL")


```

```{r LFC-circle-shapes}

View(df_LFC) #let's change all those NA's for cero's

df_LFCna <- df_LFC 
df_LFCna$lfc_JA_phyto <-  df_LFCna$lfc_JA_phyto %>% replace_na(0)
df_LFCna$lfc_SA_phyto <-  df_LFCna$lfc_SA_phyto %>% replace_na(0)
df_LFCna$lfc_JA_insects <-  df_LFCna$lfc_JA_insects %>% replace_na(0)
df_LFCna$lfc_SA_insects <-  df_LFCna$lfc_SA_insects %>% replace_na(0)

df_LFCna #ok

#re-order so JA's and SA's are together
df_LFCna <- df_LFCna %>% relocate(id, lfc_JA_phyto, lfc_JA_insects, lfc_SA_phyto, lfc_SA_insects)

#get Annotation 
AF4 <- itol.toolkit::create_unit(data = df_LFCna , 
                         key = "AF4_LFC_Shapes", 
                         type = "DATASET_EXTERNALSHAPE",
                         tree = ITS_tree)  #works

#change names and colors
AF4@field$labels <- c("JA_phyto", "JA_insects", "SA_phyto","SA_insects")
AF4@field$colors <-c(color_JA, color_JA, color_SA, color_SA)
AF4@specific_themes$externalshape$type <- 2 #change it to circle

itol.toolkit::write_unit(AF4, "./Results/03_differential_abundance/ITS_iTOL")





```

```{r LFC-heatmap}

df_LFCna
df_LFCna[df_LFCna == 0] <- NA


#get Annotation 
AFX <- itol.toolkit::create_unit(data = df_LFCna , 
                         key = "AF4_LFC_Heatmap", 
                         type = "DATASET_HEATMAP",
                         tree = ITS_tree)  #works

AFX@data$tip[AFX@data$tip == 0] <- NA #change cero's to NA's

#select colors 
AFX@specific_themes$heatmap$color$min <- "#295e10"
AFX@specific_themes$heatmap$color$max <- "#590950"
AFX@specific_themes$heatmap$color$mid <- "#ebeceb"
AFX@specific_themes$heatmap$value$mid <- 0

AFX@specific_themes$heatmap$color$nan <- "#FFFFFF"

AFX@specific_themes$heatmap$tree$tree_display <- 0

itol.toolkit::write_unit(AFX, "./Results/03_differential_abundance/ITS_iTOL") #works

```






Now I need to add the taxonomy and change the labels

```{r Taxonomy}
#first, let's change it for Family labels
#Family
df_labels_F <- df_complete2 %>%
               dplyr::select(id, Family)

AF6 <- create_unit(data = df_labels_F,
                       key = "AF6_label_Family",
                       type = "LABELS",
                       tree = ITS_tree)

itol.toolkit::write_unit(AF6, "./Results/03_differential_abundance/ITS_iTOL")

#Genus
df_labels_G <- df_complete2 %>%
               dplyr::select(id, Genus)

AF7 <- create_unit(data = df_labels_G,
                       key = "AF7_label_Genus",
                       type = "LABELS",
                       tree = ITS_tree)

itol.toolkit::write_unit(AF7, "./Results/03_differential_abundance/ITS_iTOL")

unique(df_complete2$Phylum)

#Make a color strip df for taxonomy for now
df_Phylum <- df_complete2 %>%
               dplyr::select(id, Phylum)

df_Phylum$Phylum <- df_Phylum$Phylum %>% replace_na('unasigned')

AF8 <- itol.toolkit::create_unit(data = df_Phylum, 
                         key = "AF8_Phylum", 
                         type = "DATASET_COLORSTRIP",
                         tree = ITS_tree)

itol.toolkit::write_unit(AF8, "./Results/03_differential_abundance/ITS_iTOL")

# Make a range df to color Phylum
Phylum <- unique(df_Phylum$Phylum) 
Phylum_color <- color_phylum[1:5]
Phylum_color <- c("#FB8072", "#8DD3C7", "#FFFFB3", "#BEBADA", "#80B1D3")

#make it a df
df_phyla_col <- data.frame(Phylum,Phylum_color)

#merge with df_Phylum
df_Phylum <- df_Phylum%>%
            dplyr::inner_join(df_phyla_col)

AF9 <- create_unit(data = df_Phylum, 
                      key = "AF9_Phylum_colors", 
                      type = "TREE_COLORS", 
                      subtype = "range",
                      tree = ITS_tree)

itol.toolkit::write_unit(AF9, "./Results/03_differential_abundance/ITS_iTOL")

#Finally, make a strip df for life-style
df_trophic <- df_complete2 %>%
               dplyr::select(id, Trophic.Mode)

unique(df_trophic$Trophic.Mode) #7

AF10 <- itol.toolkit::create_unit(data = df_trophic, 
                         key = "AF10_Trophic_mode", 
                         type = "DATASET_COLORSTRIP",
                         tree = ITS_tree)

itol.toolkit::write_unit(AF10, "./Results/03_differential_abundance/ITS_iTOL")




```


## Raw abundances
Quickly plot the raw abundances of those DA ASVs to check them

```{r}
#temp
otu_table <- as.data.frame(otu_table(ps_DA))
otu_table <- otu_table %>% mutate(id=rownames(.))

df_complete3 <- left_join(df_complete2, otu_table, by="id")
str(df_complete3)

df_complete4[c(1:2,4:12)] <- lapply(df_complete4[c(1:2,4:12)], factor)

#make it long
long <- df_complete3 %>% 
              tidyr::pivot_longer(cols = c(22:145), 
              names_to = "sample",
              values_to = "raw_counts",
              values_drop_na = TRUE)

#almost ready, I just need a column with plant_pathway_induced based on sample
df_samples <- data.frame(sample_data(ps_ITS))
df_samples <- df_samples %>% mutate(sample=rownames(.))%>%
              dplyr::select(c('sample', 'plant_pathway_induced')) %>% 
              mutate(plant_pathway_induced=factor(plant_pathway_induced))

levels(df_samples$plant_pathway_induced) <- c("Control", "Control", "JA" ,"SA")    

#now I just need to add this with some join
long_complete <- dplyr::left_join(long, df_samples, by="sample")
str(long_complete)
long_complete[c(1,4,7:22)] <- lapply(long_complete[c(1,4,7:22)], factor)

# Set colors
#Set colors
color_pathway_induced <- c("#BFBFBF", "#E69F00", "#4472C4")
color_experiment <- c("#CC3399", "#70AD47")
color_ctrl_vs_JA <- c("#BFBFBF", "#E69F00")
color_ctrl_vs_SA <- c("#BFBFBF", "#4472C4")


plot <- ggplot(data=subset(long_complete, Experiment=="phytohormones" &
                           DA_phyto=="JA_and_SA"),
               aes(x=plant_pathway_induced, y=raw_counts), fill=plant_pathway_induced)+
        geom_violin(alpha=0.9, colour="black", linewidth=0.6, aes(fill=plant_pathway_induced))+
        scale_fill_manual(values = color_pathway_induced)+
        facet_wrap(id~Experiment, scales="free", ncol=6)+
        geom_jitter(position = position_jitter(w = 0.1, h = 0),
                        size=1, shape=20, alpha=0.8, aes(fill=plant_pathway_induced))

levels(long_complete$DA_phyto)
ggplot(data=subset(long_complete, Experiment=="insects" &
                           DA_insects=="SA_Only"),
               aes(x=plant_pathway_induced, y=raw_counts), fill=plant_pathway_induced)+
        geom_violin(alpha=0.9, colour="black", linewidth=0.6, aes(fill=plant_pathway_induced))+
        scale_fill_manual(values = color_pathway_induced)+
        facet_wrap(id~Experiment, scales="free", ncol=6)+
        geom_jitter(position = position_jitter(w = 0.1, h = 0),
                        size=1, shape=20, alpha=0.8, aes(fill=plant_pathway_induced))


```


