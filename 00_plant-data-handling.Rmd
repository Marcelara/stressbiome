---
title: "plant_data_handling"
author: "Marcela Aragon"
date: "3/1/2024"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: 
     collapsed: false
     smooth_scroll: true
    df_print: paged
    code_folding: hide
    keep_md: true
editor_options: 
  chunk_output_type: console
---

This script will deal with arranging and cleaning the raw plant data so it's ready to use in R 


# General settings 

## Rmarkdown

```{r global settings, include=FALSE}

#Set working directory to project directory 
setwd("./")
getwd() #ok

#Set global options for r chunks
knitr::opts_chunk$set(
  echo = TRUE,#show code
  fig.width = 9,
  fig.height = 6,
  dpi = 300,
  error=TRUE, #keep knitting even if error appears
  message=FALSE, #don't show messages
  warning=FALSE, #don't show warnings
  collapse=FALSE)

```

## Loading packages

```{r loading packages, echo=TRUE}

library(knitr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(tibble)
library(readxl)

```

## Global settings for plots 

```{r settings for plots}

# Setting up white background for plots
theme_set(theme_bw())

# Set colors for soil_inocula
color_pathway_induced <- c("999999", "E69F00", "#4472C4") #control, JA and SA
color_experiment <- c("#CC3399", "#70AD47") #simulated and real herbivory

# Set axis looks
axis_looks <- theme(axis.text.x = element_text(colour = "black", size = 10,
                                               face = "bold", angle=45, hjust=1))+
  theme(axis.text.y = element_text(colour = "black", size = 12, face = "bold"))+
  theme(axis.title=element_text(size=15, face = "bold"))+
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)))

```

# Biomass

```{r biomass}

#conditioning
simu <-read_excel("./plant_data/raw_data/raw_biomass.xlsx", sheet = "phytohormones") 
real <-read_excel("./plant_data/raw_data/raw_biomass.xlsx", sheet = "real_herbivory") 

colnames(simu) #"Harvest_ID", "Stress", "Shoots" 
colnames(real) #"ID", "Treatment", "Shoot_biomass(g)", "Leaf_area"

simu2 <- simu %>% 
         select("Harvest_ID", "Stress", "Shoots")

real2 <- real %>% 
         select("ID", "Treatment", "Shoot_biomass(g)", "Leaf_area")

#change names
simu3 <- simu2 %>% 
         rename(shoot_biomass=Shoots)%>%
         rename(ID=Harvest_ID)%>%
         mutate(Leaf_area=NA)%>%
         mutate(Experiment="simulated")

real3 <- real2 %>% 
         rename(Stress=Treatment)%>%
         rename(shoot_biomass='Shoot_biomass(g)')%>%
         mutate(Experiment="real")
               
#merge
biomass <- rbind(simu3, real3)
summary(biomass)

#make factors
biomass <- as.data.frame(unclass(biomass),stringsAsFactors=TRUE)
str(biomass) #check

#let's make a new column with plant_pathway_induced
biomass2 <- biomass %>% 
            mutate(plant_pathway_induced=case_when(
                              Stress == "Aphid" ~ "SA",
                              Stress == "Chewer" ~ "JA",
                              Stress == "Control" ~ "Control",
                              Stress == "MeJA" ~ "JA",
                              Stress == "SA" ~ "SA"))

biomass <- biomass2

#save 
write.csv(biomass,"./plant_data/csv/biomass.csv", row.names = FALSE)

#clean
rm(simu, simu2, simu3, real, real2, real3, biomass2, biomass_simu, biomass_simu2, biomass_real)


#feedback



```


# Phytohormones

```{r phytohormones}

#load data
phytohormones <-read_excel("./plant_data/raw_data/raw_phytohormones.xlsx", skip=3) 

#split first column
phytohormones <- phytohormones %>% 
                 separate(name, c('Plate', 'Plate_place', 'ID', 'treatment',
                                  'Herbivory_original','Experiment_original'), sep = '[-]')
str(phytohormones)
colnames(phytohormones)

#removing weird column '...8'
phytohormones <- phytohormones[ -c(13) ]

#making factors 
phytohormones[c(1:6)] <- lapply(phytohormones[c(1:6)], factor)

#check
levels(phytohormones$treatment)
levels(phytohormones$Herbivory_original)
levels(phytohormones$Experiment_original)

#New columns:
#Phase
phytohormones <- phytohormones %>%  
                   mutate(Phase =
                            case_when(
                              Experiment_original == "Family" ~ "conditioning",
                              Experiment_original == "Haris" ~ "conditioning",
                              Experiment_original == "Herbivory" ~ "feedback",
                              Experiment_original == "Hormones" ~ "feedback")) 


phytohormones2 <- phytohormones %>%  
                   mutate(Experiment = 
                         case_when(
                              Experiment_original == "Family" ~ "simulated",
                              Experiment_original == "Haris" ~ "real_insects",
                              Experiment_original == "Herbivory" ~ "real_insects",
                              Experiment_original == "Hormones" ~ "simulated")) 
  

phytohormones3 <- phytohormones2 %>%  
                   mutate(Stress = 
                         case_when(
                           Herbivory_original == "without" ~ "Control",
                           Herbivory_original == "caterpillar" ~ "Chewer",
                           Herbivory_original == "aphid" ~ "Aphid",
                           Herbivory_original == "mock" ~ "Control",
                           Herbivory_original == "MeJA" ~ "JA",
                           Herbivory_original == "SA" ~ "SA"))
                           

phytohormones4 <- phytohormones3 %>%  
                   mutate(soil_inocula = 
                         case_when(
                           Phase == "conditioning" ~ "NA",
                           treatment == "control_live" ~ "non-conditioned",
                           treatment == "aphid" ~ "SA-conditioned",
                           treatment == "caterpillar" ~ "JA-conditioned",
                           treatment == "MeJA" ~ "JA-conditioned",
                           treatment == "SA" ~ "SA-conditioned",
                           treatment == "control_plant" & Experiment == "simulated" ~ "control-conditioned",
                           treatment == "control_plant" & Experiment == "real_insects" ~ "control-conditioned")) 


phytohormones5 <- phytohormones4 %>% 
                  mutate(plant_pathway_induced=case_when(
                              Phase == "feedback"  ~ "NA",
                              Phase == "conditioning" & Stress == "Chewer" ~ "JA",
                              Phase == "conditioning" & Stress == "Control" ~ "Control",
                              Phase == "conditioning" & Stress == "Aphid" ~ "SA",
                              Phase == "conditioning" & Stress == "JA" ~ "JA",
                              Phase == "conditioning" & Stress == "SA" ~ "SA"))

# re-naming
colnames(phytohormones5)
phytohormones6 <- phytohormones5 %>%  
                   rename(sum_JA_Ile = 'sum JA-Ile',
                          cis_OPDA = 'cis-OPDA',
                          OH_JA = 'OH-JA',
                          OH_JA_Ile = 'OH-JA-Ile',
                          COOH_JA_Ile = 'COOH-JA-Ile',
                          weight_mg='weight (mg)',
                          herbivory='Herbivory_original')   



#making new columns factors
phytohormones6[c(16:20)] <- lapply(phytohormones6[c(16:20)], factor)

#deleting non-necessary columns 
phytohormones7 <- phytohormones6 %>% 
                  select(-c(Experiment_original, Plate, Plate_place))

#making new column 'Phytohormones'. Look out later to remove those with NA's (not-dried samples for instance)
phytohormones8 <- phytohormones7 %>% 
                  mutate(Phytohormones = "1")

#re-arrange
phytohormones9 <- phytohormones8 %>% 
                  relocate(ID,Phase,Experiment,Stress,herbivory,soil_inocula,plant_pathway_induced, Phytohormones)
str(phytohormones9)

phytohormones9[8] <- lapply(phytohormones9[8], factor)

phytohormones <- phytohormones9

#quick check
ggpairs(phytohormones[,c("Experiment","Phase","Stress","soil_inocula", "plant_pathway_induced", "SA")],
        mapping = aes(color = Experiment)) #there is something weird but let's leave it like that for now

#save 
saveRDS(phytohormones, file = "./plant_data/phytohormones.rds")
write.csv(phytohormones,"./plant_data/csv/phytohormones.csv", row.names = FALSE)

#clean
rm(phytohormones1, phytohormones2, phytohormones3, phytohormones4, phytohormones5,
   phytohormones6, phytohormones7, phytohormones8, phytohormones9)
dev.off()

```

Now I just need to be wary of the 'Loading data' section for each script as some names of treatments have changed (i.e. MeJA_treated by MeJA-treated)!

# Glucosinolates 

```{r glucosinolates}

glucosinolates <-read_excel("./plant_data/raw_data/raw_glucosinolates.xlsx", skip=2) 
str(glucosinolates)

#removing extra columns
glucosinolates <- glucosinolates[ -c(11:13) ]

#separate 1st column 
glucosinolates2 <- glucosinolates %>% 
                 separate(Name, c('Plate', 'Plate_place', 'ID', 'treatment',
                                  'Herbivory_original','Experiment_original'), sep = '[-]')

glucosinolates3 <- glucosinolates2 %>%
                   mutate(across(where(is.character), factor))

str(glucosinolates3)

#check
levels(glucosinolates3$treatment)
levels(glucosinolates3$Herbivory_original)
levels(glucosinolates3$Experiment_original)


#New columns:
#Phase
glucosinolates4 <- glucosinolates3 %>%  
                   mutate(Phase =
                            case_when(
                              Experiment_original == "Family" ~ "conditioning",
                              Experiment_original == "Haris" ~ "conditioning",
                              Experiment_original == "Herbivory" ~ "feedback",
                              Experiment_original == "Hormones" ~ "feedback")) %>%
                   mutate(across(Phase, as.factor))
                   

glucosinolates5 <- glucosinolates4 %>%  
                   mutate(Experiment = 
                         case_when(
                              Experiment_original == "Family" ~ "simulated",
                              Experiment_original == "Haris" ~ "real_insects",
                              Experiment_original == "Herbivory" ~ "real_insects",
                              Experiment_original == "Hormones" ~ "simulated")) %>%
                   mutate(across(Experiment, as.factor))
  

glucosinolates6 <- glucosinolates5 %>%  
                   mutate(Stress = 
                         case_when(Herbivory_original == "without" ~ "Control",
                           Herbivory_original == "caterpillar" ~ "Chewer",
                           Herbivory_original == "aphid" ~ "Aphid",
                           Herbivory_original == "mock" ~ "Control",
                           Herbivory_original == "MeJA" ~ "JA",
                           Herbivory_original == "SA" ~ "SA")) %>%
                   mutate(across(Stress, as.factor))
  

glucosinolates7 <- glucosinolates6 %>%  
                   mutate(soil_inocula = 
                         case_when(
                           Phase == "conditioning" ~ "NA",
                           treatment == "control_live" ~ "non-conditioned",
                           treatment == "aphid" ~ "SA-conditioned",
                           treatment == "caterpillar" ~ "JA-conditioned",
                           treatment == "MeJA" ~ "JA-conditioned",
                           treatment == "SA" ~ "SA-conditioned",
                           treatment == "control_plant" & Experiment == "simulated" ~ "control-conditioned",
                           treatment == "control_plant" & Experiment == "real_insects" ~ "control-conditioned")) %>%
                   mutate(across(soil_inocula, as.factor))

glucosinolates8 <- glucosinolates7 %>% 
                  mutate(plant_pathway_induced=case_when(
                              Phase == "feedback"  ~ "NA",
                              Phase == "conditioning" & Stress == "Chewer" ~ "JA",
                              Phase == "conditioning" & Stress == "Control" ~ "Control",
                              Phase == "conditioning" & Stress == "Aphid" ~ "SA",
                              Phase == "conditioning" & Stress == "JA" ~ "JA",
                              Phase == "conditioning" & Stress == "SA" ~ "SA"))%>%
                   mutate(across(plant_pathway_induced, as.factor))

#checking
str(glucosinolates8)
summary(glucosinolates8)

#deleting non-necessary columns 
glucosinolates9 <- glucosinolates8 %>% 
                  select(-c(Experiment_original, Plate, Plate_place))

#making new column 'glucosinolates' & removing those with NA's (not-dried samples for instance)
glucosinolates10 <- glucosinolates9 %>% 
                  mutate(Glucosinolates = "1")%>% 
                  mutate(across(Glucosinolates, as.factor))%>% 
                  rename(weight_mg='weight [mg]',
                         herbivory=Herbivory_original)
                  

#change names of columns by adding Glu_ because as they start with a number it creates problems  
glucosinolates11 <- glucosinolates10 %>%
                  rename_with(.cols = 5:12, function(x){paste0("Glu_", x)}) 

glucosinolates11 <- glucosinolates11 %>%
                  rename(Glu_3MSOP = Glu_3MSOP...4)

#re-arrange
glucosinolates12 <- glucosinolates11 %>% 
                  relocate(ID,Phase,Experiment,Stress,herbivory,soil_inocula,plant_pathway_induced, Glucosinolates)

str(glucosinolates12)

glucosinolates <- glucosinolates12

#quick check
ggpairs(glucosinolates[,c("Experiment","Phase","Stress","soil_inocula", "plant_pathway_induced", "Glu_total")],
        mapping = aes(color = Experiment)) #there is something weird but let's leave it like that for now

#save 
saveRDS(glucosinolates, file = "./plant_data/glucosinolates.rds")
write.csv(glucosinolates,"./plant_data/csv/glucosinolates.csv", row.names = FALSE)

#clean
rm(glucosinolates2, glucosinolates3, glucosinolates4, glucosinolates5, glucosinolates6,
   glucosinolates7, glucosinolates8, glucosinolates9, glucosinolates10, glucosinolates11, glucosinolates12)

```


# Caterpillars 

```{r caterpillars}

#simulated
cat.h <-read_excel("./data/raw_data/raw_caterpillars.xlsx", sheet = "Hormones")
str(cat.h)

#removing extra columns
cat.h <- cat.h[ -c(10) ]

#separate 1st column 
cat.h <- cat.h %>% 
                 separate(Treatment, c('soil_original', 'herbivory_original'), sep = '[-]')

#making factors 
cat.h[c(1:5)] <- lapply(cat.h[c(1:5)], factor)

#assigning soil_inocula and herbivory with plant ID from feedback  
df <- phytohormones  
colnames(df)

#deleting non-necessary columns 
df <- df[ -c(1:2,4:12, 17) ]
str(df)

#join
cat.hormones <- merge(x=cat.h,y=df,by="ID",all.x=TRUE)
str(cat.hormones)

#removing plants without caterpillar measurement
cat.hormones <- subset(cat.hormones, ID != "146" & ID!= "182" & ID != "208" & ID != "215") %>% 
                droplevels()

cat.hormones[c(6:10)] <- lapply(cat.hormones[c(6:10)], as.numeric)

#insects
cat.i <-read_excel("./data/raw_data/raw_caterpillars.xlsx", sheet = "Insects")
str(cat.i)

#making factors 
cat.i[c(1:7)] <- lapply(cat.i[c(1:7)], factor)

#renaming
cat.i <- cat.i %>% 
         rename(soil_original = Soil) %>% 
         rename(herbivory_original = Herbivory)

#join
cat.insects <- merge(x=cat.i,y=df,by="ID",all.x=TRUE)
str(cat.insects)
cat.insects <- cat.insects[-c(3:4)]

#Merge both df's 
caterpillars <- rbind(x=cat.hormones,y=cat.insects)
str(caterpillars)

#save 
saveRDS(caterpillars, file = "./data/R_data/caterpillars.rds")
write.csv(caterpillars,"./data/csv/caterpillars.csv", row.names = FALSE)

```




# Aphids

```{r aphids}

aphids.h <-read_excel("./data/raw_data/raw_aphids.xlsx", sheet = "Hormones")
str(aphids.h)

#removing extra columns
aphids.h <- aphids.h[ -c(9) ]

#separate 1st column 
aphids.h <- aphids.h %>% 
                 separate(Treatment, c('soil_original', 'herbivory_original'), sep = '[-]')

#making factors 
aphids.h[c(1:5)] <- lapply(aphids.h[c(1:5)], factor)

#assigning soil_inocula and herbivory with plant ID from feedback  
df <- phytohormones  
colnames(df)

#deleting non-necessary columns 
df <- df[ -c(1:2,4:12, 17) ]
str(df)

#join
aphids.hormones <- merge(x=aphids.h,y=df,by="ID",all.x=TRUE)
aphids.hormones <- aphids.hormones[-c(41:42), ]

#filling plant #140 that was missing for phytohormones
aphids.h <- aphids.hormones %>%  
                   mutate(Phase = 
                         case_when(
                           ID == "140" ~ "feedback",
                           TRUE ~ as.character (Phase))) %>%
                   mutate(Experiment = 
                            case_when(
                              ID == "140" ~ "phytohormones",
                              TRUE ~ as.character (Experiment)))%>%
                   mutate(herbivory = 
                            case_when(
                              ID == "140" ~ "aphid-infested",
                              TRUE ~ as.character (herbivory)))%>%
                  mutate(soil_inocula = 
                            case_when(
                              ID == "140" ~ "mock-conditioned",
                              TRUE ~ as.character (soil_inocula)))
                               
#changing column names for aphids 
str(aphids.h)
colnames(aphids.h)
aphids.hormones <- aphids.h %>%  
                   rename(dpi_8 = precount) %>%
                   rename(dpi_14 = total)%>%
                   relocate(ID, Phase, Experiment, soil_inocula, herbivory, dpi_8, dpi_14)
str(aphids.hormones)
aphids.hormones <- aphids.hormones[ -c(10:13) ]

#Insect-Experiment 
aphids.i <-read_excel("./data/raw_data/raw_aphids.xlsx", sheet = "Insects")
str(aphids.i)

#making factors 
aphids.i[c(1:3)] <- lapply(aphids.i[c(1:3)], factor)

#join
aphids.insects <- merge(x=aphids.i,y=df,by="ID",all.x=TRUE)

#changing column names for aphids 
colnames(aphids.i)
aphids.insects <- aphids.insects %>%
                   rename(dpi_8 ='1st count') %>%
                   rename(dpi_14 = Total)%>%
                   relocate(ID, Phase, Experiment, soil_inocula, herbivory, dpi_8, dpi_14)
str(aphids.insects)
aphids.insects <- aphids.insects[ -c(8:9) ]

#getting block and place missing
blocks <-read_excel("./data/raw_data/raw_aphids.xlsx", sheet = "Insects_Block")
str(blocks)

#making factors 
blocks[c(1:5)] <- lapply(blocks[c(1:5)], factor)

#removing trt 
blocks <- blocks[-c(3:4)]

#join
aphids.insects <- merge(x=aphids.insects,y=blocks,by="ID",all.x=TRUE)


#Merge both df's 
aphids <- rbind(x=aphids.hormones,y=aphids.insects)

#save 
saveRDS(aphids, file = "./data/R_data/aphids.rds")
write.csv(aphids,"./data/csv/aphids.csv", row.names = FALSE)

```


# Caterpillars 

```{r caterpillars}

phytohormones <- readRDS("./data/R_data/phytohormones.rds")

#hormones
cat.h <-read_excel("./data/raw_data/raw_caterpillars.xlsx", sheet = "Hormones")
str(cat.h)

#removing extra columns
cat.h <- cat.h[ -c(10) ]

#separate 1st column 
cat.h <- cat.h %>% 
                 separate(Treatment, c('soil_original', 'herbivory_original'), sep = '[-]')

#making factors 
cat.h[c(1:5)] <- lapply(cat.h[c(1:5)], factor)

#assigning soil_inocula and herbivory with plant ID from feedback  
df <- phytohormones  
colnames(df)

#deleting non-necessary columns 
df <- df[ -c(1:2,4:12, 17) ]
str(df)

#join
cat.hormones <- merge(x=cat.h,y=df,by="ID",all.x=TRUE)
str(cat.hormones)

#removing plants without caterpillar measurement
cat.hormones <- subset(cat.hormones, ID != "146" & ID!= "182" & ID != "208" & ID != "215") %>% 
                droplevels()

cat.hormones[c(6:10)] <- lapply(cat.hormones[c(6:10)], as.numeric)

#insects
cat.i <-read_excel("./data/raw_data/raw_caterpillars.xlsx", sheet = "Insects")
str(cat.i)

#making factors 
cat.i[c(1:7)] <- lapply(cat.i[c(1:7)], factor)

#renaming
cat.i <- cat.i %>% 
         rename(soil_original = Soil) %>% 
         rename(herbivory_original = Herbivory)

#join
cat.insects <- merge(x=cat.i,y=df,by="ID",all.x=TRUE)
str(cat.insects)
cat.insects <- cat.insects[-c(3:4)]

#Merge both df's 
caterpillars <- rbind(x=cat.hormones,y=cat.insects)
str(caterpillars)

#save 
saveRDS(caterpillars, file = "./data/R_data/caterpillars.rds")
write.csv(caterpillars,"./data/csv/caterpillars.csv", row.names = FALSE)

```

# Metabolites-SIMCA

```{r Metabolites-SIMCA}

phytohormones <- readRDS(file = "./data/R_data/phytohormones.rds")
str(phytohormones)

glucosinolates <- readRDS(file = "./data/R_data/glucosinolates.rds")
str(glucosinolates)

p <- phytohormones[,c(3,5:16)] %>% 
     mutate(phyto="1")

g <- glucosinolates[,c(3,5:16)] %>%
     mutate(gluco="1")


#joining
metabolites <- left_join(p,g, by="ID")
colnames(metabolites)
str(metabolites)



metabolites <- metabolites %>% 
               mutate(Experiment= Experiment.x)%>% 
               mutate(Phase = Phase.x)%>% 
               mutate(Herbivory = herbivory.x)%>% 
               mutate(soil_inocula = soil_inocula.x)

str(metabolites)
colnames(metabolites)



#removing repeated columns
met <- subset(metabolites, select = -c(Phase.x,Experiment.x, herbivory.x, soil_inocula.x, Phase.y, Experiment.y, herbivory.y, soil_inocula.y) )



#making new columns 

met <- met %>% 
       mutate(both = 
                case_when((phyto == 1 & gluco == 1) ~ 1))%>%
       mutate(pathway_induced = 
                case_when(soil_inocula == "aphid-conditioned" ~ "SA",
                           soil_inocula == "caterpillar-conditioned" ~ "JA",
                           soil_inocula == "MeJA-conditioned" ~ "JA",
                           soil_inocula == "mock-conditioned" ~ "Control_Plant",
                           soil_inocula == "non-conditioned" ~ "Control_No-Plant",
                           soil_inocula == "SA-conditioned" ~ "SA",
                           soil_inocula == "uninfested-conditioned" ~ "Control_Plant",
                          (soil_inocula == "No-inocula" & Herbivory == "aphid-infested") ~ "SA",
                          (soil_inocula == "No-inocula" & Herbivory == "caterpillar-infested") ~ "JA",
                          (soil_inocula == "No-inocula" & Herbivory == "MeJA-treated") ~ "JA",
                          (soil_inocula == "No-inocula" & Herbivory == "mock-treated") ~ "Control_Plant",
                          (soil_inocula == "No-inocula" & Herbivory == "not-infested") ~ "Control_Plant",
                          (soil_inocula == "No-inocula" & Herbivory == "SA-treated") ~ "SA")) 
str(met)
met <- met %>% 
       relocate(c(Experiment, Phase, Herbivory, soil_inocula, pathway_induced, both, phyto, gluco), .after = ID)      

summary(met)
met[c(6:9)] <- lapply(met[c(6:9)], factor)

met.cond <- subset(met, Phase == "conditioning")
met.feed.both <- subset(met, Phase == "feedback" & both == "1")
met.feed.phyto <- subset(met, Phase == "feedback")
met.feed.glu <- subset(met, Phase == "feedback" & gluco == "1")

#Add extra column
met.feed.phyto <- met.feed.phyto %>% 
                  mutate(combination=
                           case_when())

levels(met.feed.phyto$Herbivory)
levels(met.feed.phyto$soil_inocula)



#####
p.f <- subset(p, Phase=="feedback") %>% droplevels()
g.f <- subset(g, Phase=="feedback") %>% droplevels()

metabolites.f <- left_join(p.f,g.f, by="ID")
colnames(metabolites.f)
str(metabolites.f)

metabolites.f <- metabolites.f %>% 
               mutate(Experiment= Experiment.x)%>% 
               mutate(Phase = Phase.x)%>% 
               mutate(Herbivory = herbivory.x)%>% 
               mutate(soil_inocula = soil_inocula.x)

str(metabolites.f)
colnames(metabolites.f)

met.f <- subset(metabolites.f, select = -c(Phase.x,Experiment.x, herbivory.x, soil_inocula.x, Phase.y, Experiment.y, herbivory.y, soil_inocula.y) )


met.f <- met.f %>% 
       mutate(both = 
                case_when((phyto == 1 & gluco == 1) ~ 1))%>%
       mutate(pathway_induced = 
                case_when(soil_inocula == "aphid-conditioned" ~ "SA",
                           soil_inocula == "caterpillar-conditioned" ~ "JA",
                           soil_inocula == "MeJA-conditioned" ~ "JA",
                           soil_inocula == "mock-conditioned" ~ "Control_Plant",
                           soil_inocula == "non-conditioned" ~ "Control_No-Plant",
                           soil_inocula == "SA-conditioned" ~ "SA",
                           soil_inocula == "uninfested-conditioned" ~ "Control_Plant"))
                          

met.f <- met.f %>% 
       relocate(c(Experiment, Phase, Herbivory, soil_inocula, pathway_induced, both, phyto, gluco), .after = ID)      
str(met.f)

summary(met)
met.f[c(7:9)] <- lapply(met.f[c(7:9)], factor)

#Add extra column
met.f <- met.feed.phyto %>% 
                  mutate(combination=
                           case_when(
                             (soil_inocula == "aphid-conditioned" & Herbivory == "not-infested")~ "Ac-Ni",
                             (soil_inocula == "aphid-conditioned" & Herbivory == "caterpillar-infested")~ "Ac-Ci",
                             (soil_inocula == "aphid-conditioned" & Herbivory == "aphid-infested")~ "Ac-Ai",
                             (soil_inocula == "caterpillar-conditioned" & Herbivory == "not-infested")~ "Cc-Ni",
                             (soil_inocula == "caterpillar-conditioned" & Herbivory == "caterpillar-infested")~ "Cc-Ci",
                             (soil_inocula == "caterpillar-conditioned" & Herbivory == "aphid-infested")~ "Cc-Ai",
                             (soil_inocula == "MeJA-conditioned" & Herbivory == "not-infested")~ "Mec-Ni",
                             (soil_inocula == "MeJA-conditioned" & Herbivory == "caterpillar-infested")~ "Mec-Ci",
                             (soil_inocula == "MeJA-conditioned" & Herbivory == "aphid-infested")~ "Mec-Ai",
                             (soil_inocula == "mock-conditioned" & Herbivory == "not-infested")~ "CMc-Ni",
                             (soil_inocula == "mock-conditioned" & Herbivory == "caterpillar-infested")~ "CMc-Ci",
                             (soil_inocula == "mock-conditioned" & Herbivory == "aphid-infested")~ "CMc-Ai",
                             (soil_inocula == "non-conditioned" & Herbivory == "not-infested")~ "Noc-Ni",
                             (soil_inocula == "non-conditioned" & Herbivory == "caterpillar-infested")~ "Noc-Ci",
                             (soil_inocula == "non-conditioned" & Herbivory == "aphid-infested")~ "Noc-Ai",
                             (soil_inocula == "SA-conditioned" & Herbivory == "not-infested")~ "SAc-Ni",
                             (soil_inocula == "SA-conditioned" & Herbivory == "caterpillar-infested")~ "SAc-Ci",
                             (soil_inocula == "SA-conditioned" & Herbivory == "aphid-infested")~ "SAc-Ai",
                             (soil_inocula == "uninfested-conditioned" & Herbivory == "not-infested")~ "CUc-Ni",
                             (soil_inocula == "uninfested-conditioned" & Herbivory == "caterpillar-infested")~ "CUc-Ci",
                             (soil_inocula == "uninfested-conditioned" & Herbivory == "aphid-infested")~ "CUc-Ai"))%>% 
            relocate(combination, .after=soil_inocula)


met.feed.both <- subset(met.f, Phase == "feedback" & both == "1")
met.feed.both.h <- subset(met.f, Experiment == "phytohormones")
met.feed.both.i <- subset(met.f, Experiment == "real_insects")
met.feed.phyto <- subset(met, Phase == "feedback")
met.feed.glu <- subset(met, Phase == "feedback" & gluco == "1")


#save 
saveRDS(met, file = "./data/R_data/metabolites.rds")
write.csv(met,"./data/csv/metabolites.csv", row.names = FALSE)

#save it to SIMCA folder
write.csv(met.cond,"./PLS_metabolite_analysis/data/conditioning_metabolites.csv", row.names = FALSE)
write.csv(met.feed.both,"./PLS_metabolite_analysis/data/feedback_metabolites.csv", row.names = FALSE)
write.csv(met.feed.both.h,"./PLS_metabolite_analysis/data/feedback_HormoneExp_metabolites.csv", row.names = FALSE)
write.csv(met.feed.both.i,"./PLS_metabolite_analysis/data/feedback_InsectsExp_metabolites.csv", row.names = FALSE)
write.csv(met.feed.phyto,"./PLS_metabolite_analysis/data/feedback_phytohormones.csv", row.names = FALSE)
write.csv(met.feed.glu,"./PLS_metabolite_analysis/data/feedback_glucosinolates.csv", row.names = FALSE)
str(met.feed.both)

```






